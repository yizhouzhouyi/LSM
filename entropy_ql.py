# -*- coding: utf-8 -*-
"""
Created on Fri Nov 29 10:38:22 2019

@author: yizhou
"""

import numpy as np
import pandas as pd
import math
from manifold_align import transformq,cos_sim,compute_cxy,low_rank_repr,low_rank_align

class QLearningTable:
    #initialize
    def __init__(self,actions,learning_rate=0.02,reward_decay=0.9,e_greedy=0.9):
        self.actions = actions
        self.lr = learning_rate
        self.gamma = reward_decay
        self.epsilon = e_greedy
        #self.q_table = np.zeros((16,4))
        self.q_table = pd.DataFrame(columns=self.actions)
        self.state_dict = {
                '[5.0, 5.0, 35.0, 35.0]':0,
                '[45.0, 5.0, 75.0, 35.0]':1,
                '[85.0, 5.0, 115.0, 35.0]':2,
                '[125.0, 5.0, 155.0, 35.0]':3,
                '[165.0, 5.0, 195.0, 35.0]':4,
                '[205.0, 5.0, 235.0, 35.0]':5,
                '[245.0, 5.0, 275.0, 35.0]':6,
                '[285.0, 5.0, 315.0, 35.0]':7,
                '[325.0, 5.0, 355.0, 35.0]':8,
                '[365.0, 5.0, 395.0, 35.0]':9,
                '[5.0, 45.0, 35.0, 75.0]':10,
                '[45.0, 45.0, 75.0, 75.0]':11,
                '[85.0, 45.0, 115.0, 75.0]':12,
                '[125.0, 45.0, 155.0, 75.0]':13,
                '[165.0, 45.0, 195.0, 75.0]':14,
                '[205.0, 45.0, 235.0, 75.0]':15,
                '[245.0, 45.0, 275.0, 75.0]':16,
                '[285.0, 45.0, 315.0, 75.0]':17,
                '[325.0, 45.0, 355.0, 75.0]':18,
                '[365.0, 45.0, 395.0, 75.0]':19,
                '[5.0, 85.0, 35.0, 115.0]':20,
                '[45.0, 85.0, 75.0, 115.0]':21,
                '[85.0, 85.0, 115.0, 115.0]':22,
                '[125.0, 85.0, 155.0, 115.0]':23,
                '[165.0, 85.0, 195.0, 115.0]':24,
                '[205.0, 85.0, 235.0, 115.0]':25,
                '[245.0, 85.0, 275.0, 115.0]':26,
                '[285.0, 85.0, 315.0, 115.0]':27,
                '[325.0, 85.0, 355.0, 115.0]':28,
                '[365.0, 85.0, 395.0, 115.0]':29,
                '[5.0, 125.0, 35.0, 155.0]':30,
                '[45.0, 125.0, 75.0, 155.0]':31,
                '[85.0, 125.0, 115.0, 155.0]':32,
                '[125.0, 125.0, 155.0, 155.0]':33,
                '[165.0, 125.0, 195.0, 155.0]':34,
                '[205.0, 125.0, 235.0, 155.0]':35,
                '[245.0, 125.0, 275.0, 155.0]':36,
                '[285.0, 125.0, 315.0, 155.0]':37,
                '[325.0, 125.0, 355.0, 155.0]':38,
                '[365.0, 125.0, 395.0, 155.0]':39,
                '[5.0, 165.0, 35.0, 195.0]':40,
                '[45.0, 165.0, 75.0, 195.0]':41,
                '[85.0, 165.0, 115.0, 195.0]':42,
                '[125.0, 165.0, 155.0, 195.0]':43,
                '[165.0, 165.0, 195.0, 195.0]':44,
                '[205.0, 165.0, 235.0, 195.0]':45,
                '[245.0, 165.0, 275.0, 195.0]':46,
                '[285.0, 165.0, 315.0, 195.0]':47,
                '[325.0, 165.0, 355.0, 195.0]':48,
                '[365.0, 165.0, 395.0, 195.0]':49,
                '[5.0, 205.0, 35.0, 235.0]':50,
                '[45.0, 205.0, 75.0, 235.0]':51,
                '[85.0, 205.0, 115.0, 235.0]':52,
                '[125.0, 205.0, 155.0, 235.0]':53,
                '[165.0, 205.0, 195.0, 235.0]':54,
                '[205.0, 205.0, 235.0, 235.0]':55,
                '[245.0, 205.0, 275.0, 235.0]':56,
                '[285.0, 205.0, 315.0, 235.0]':57,
                '[325.0, 205.0, 355.0, 235.0]':58,
                '[365.0, 205.0, 395.0, 235.0]':59,
                '[5.0, 245.0, 35.0, 275.0]':60,
                '[45.0, 245.0, 75.0, 275.0]':61,
                '[85.0, 245.0, 115.0, 275.0]':62,
                '[125.0, 245.0, 155.0, 275.0]':63,
                '[165.0, 245.0, 195.0, 275.0]':64,
                '[205.0, 245.0, 235.0, 275.0]':65,
                '[245.0, 245.0, 275.0, 275.0]':66,
                '[285.0, 245.0, 315.0, 275.0]':67,
                '[325.0, 245.0, 355.0, 275.0]':68,
                '[365.0, 245.0, 395.0, 275.0]':69,
                '[5.0, 285.0, 35.0, 315.0]':70,
                '[45.0, 285.0, 75.0, 315.0]':71,
                '[85.0, 285.0, 115.0, 315.0]':72,
                '[125.0, 285.0, 155.0, 315.0]':73,
                '[165.0, 285.0, 195.0, 315.0]':74,
                '[205.0, 285.0, 235.0, 315.0]':75,
                '[245.0, 285.0, 275.0, 315.0]':76,
                '[285.0, 285.0, 315.0, 315.0]':77,
                '[325.0, 285.0, 355.0, 315.0]':78,
                '[365.0, 285.0, 395.0, 315.0]':79,
                '[5.0, 325.0, 35.0, 355.0]':80,
                '[45.0, 325.0, 75.0, 355.0]':81,
                '[85.0, 325.0, 115.0, 355.0]':82,
                '[125.0, 325.0, 155.0, 355.0]':83,
                '[165.0, 325.0, 195.0, 355.0]':84,
                '[205.0, 325.0, 235.0, 355.0]':85,
                '[245.0, 325.0, 275.0, 355.0]':86,
                '[285.0, 325.0, 315.0, 355.0]':87,
                '[325.0, 325.0, 355.0, 355.0]':88,
                '[365.0, 325.0, 395.0, 355.0]':89,
                '[5.0, 365.0, 35.0, 395.0]':90,
                '[45.0, 365.0, 75.0, 395.0]':91,
                '[85.0, 365.0, 115.0, 395.0]':92,
                '[125.0, 365.0, 155.0, 395.0]':93,
                '[165.0, 365.0, 195.0, 395.0]':94,
                '[205.0, 365.0, 235.0, 395.0]':95,
                '[245.0, 365.0, 275.0, 395.0]':96,
                '[285.0, 365.0, 315.0, 395.0]':97,
                '[325.0, 365.0, 355.0, 395.0]':98,
                '[365.0, 365.0, 395.0, 395.0]':99
                }
        self.source_task_1 = {
        0:[-0.3709541969116535,-0.3396212667163298,-0.1989570046868023,0,0,-0.1286153598306451,0,0.08465066987095218,-0.24352429163231565,0.04757723811419613,0,0,-0.2053297695305148,0.08994222837252801,0.2112779134281842,-0.11838106844931884,-1.8209306240276915,0.6602175823091461,0,0,0,-0.08008591777797971,-0.03603740428929187,-0.1,-0.01651500859929469,0,-0.12632089381741884,-0.1292490945133586,-0.490099501,-4.583149240331462,-0.026031301006920016,0,0,0,1.239912213774061,0,0,0,-0.009980331858965193,0,-0.199,-0.1,-0.0059053487599,-0.0029791,0,-0.011744454698142401,0.007343640169236691,-0.001009081,0,-0.001,-0.001,-0.0019990809999999998,-0.003032678025991,0,1.3229850456531065,0,0,-0.58519850599,1.913699560831725,0,0,-0.001,0,-0.001999,0,0,0,0,0.01070428179204266],
        1:[-6.302703623502732,-5.870503288661116,-4.690944570448866,0,0,-5.2941335841434976,0,3.400829014924697,0.06905015792112475,4.053604793127147,0,0,2.0466800748167655,5.443702156678858,-0.060593171535506876,-0.1171614277277614,-0.14172274204292618,-3.7017636879676745,0,0,0,-0.0787547971310616,-0.02366106557752676,-0.02558869566967903,-0.29701,0,-0.6793465209301,-0.956179249911955,-0.13453856798351713,7.011325528859328,-0.022419604867924384,0,0,0,7.907994203410775,0,0,0,-0.0126410534616463,0,0.0015094302025858803,-0.1,-0.0059140806409,-0.0040552669225009,0,-0.3940399,-0.0048333225924866155,-0.001,0,-0.001,-0.001,-0.00199,-0.003949399,0,8.899651912999541,0,0,0.0004272749900000002,9.999967709497486,0,0,0,0,-0.002016901,-0.1,0,-0.1,0,0],
        2:[1.1224457923089828,1.625692071403515,2.1830860928266533,0,0,2.775984513035502,0,-0.2681207728803229,-2.143218591927811,-0.10011881902082137,0,0,-1.3125418723102171,-3.6381451393612876,4.734641768838634,1.420572126727108,0.6509050566314944,6.195119862921724,0,0,0,-0.3940399,-0.29701,-0.025036597224177636,-0.015935775132625576,0,-0.12833574847812243,-0.1298187633276644,-0.13450168605440854,0.06773050814786974,-0.29701,0,0,0,0.29843677338132196,0,0,0,-0.199,0,-0.015344210095689275,-0.00973617772760607,-0.004990009995001,-0.002997001,0,0.2927318922919926,-0.1,-0.001,-0.001,0,-0.001,-0.001999,-0.002997001,0,0.3079121569796791,0,0,3.339153701917229,0.22609717481300196,0,0,0.3940399,0,-0.001999,-0.001,-0.001,-0.001,0,0],
        3:[-0.442892712793747,-0.3689027137779815,-0.20715416064800224,0,0,-0.09469979167133748,0,0.018240336767916046,-0.2465770698458092,-4.010439935338387,0,0,-0.16320982219592864,0.36744000683835587,-0.10559898268450518,-0.11955787623191463,-0.14304125784009966,0.010875283083688082,0,0,0,-1.2247897700103203,-0.036215590085786946,-0.29701,-0.1,0,-0.12908970130014918,-0.7725530557207989,-0.7725530557207989,0.807276833297698,1.254220098045451,0,0,0,-2.9655230500043057,0,0,0,2.1859759554606066,0,-0.29701,-0.009314145560784467,-0.005120796585346893,-0.1,0,-0.009926668192716079,2.2996683237390023,2.1638489917872636,0,0,-0.1,-0.1,-0.1,0,-1.9836941046095404,0,0,0.0007971787792951594,0.5416857202206619,0,0,0,0,-0.00199,-0.001,0,0,0,0]
        }
        self.source_task1 = pd.DataFrame(self.source_task_1)
        self.source_task1.index = ['[5.0, 5.0, 35.0, 35.0]','[45.0, 5.0, 75.0, 35.0]','[85.0, 5.0, 115.0, 35.0]','[45.0, 45.0, 75.0, 75.0]','[5.0, 45.0, 35.0, 75.0]','[125.0, 5.0, 155.0, 35.0]','[85.0, 45.0, 115.0, 75.0]','[165.0, 5.0, 195.0, 35.0]','[205.0, 5.0, 235.0, 35.0]','[165.0, 45.0, 195.0, 75.0]','[125.0, 45.0, 155.0, 75.0]','[245.0, 5.0, 275.0, 35.0]','[205.0, 45.0, 235.0, 75.0]','[205.0, 85.0, 235.0, 115.0]','[165.0, 85.0, 195.0, 115.0]','[165.0, 125.0, 195.0, 155.0]','[125.0, 85.0, 155.0, 115.0]','[205.0, 125.0, 235.0, 155.0]','[205.0, 165.0, 235.0, 195.0]','[245.0, 45.0, 275.0, 75.0]','[245.0, 85.0, 275.0, 115.0]','[165.0, 165.0, 195.0, 195.0]','[165.0, 205.0, 195.0, 235.0]','[125.0, 205.0, 155.0, 235.0]','[125.0, 245.0, 155.0, 275.0]','[85.0, 245.0, 115.0, 275.0]','[125.0, 125.0, 155.0, 155.0]','[85.0, 125.0, 115.0, 155.0]','[85.0, 85.0, 115.0, 115.0]','[245.0, 125.0, 275.0, 155.0]','[285.0, 125.0, 315.0, 155.0]','[325.0, 125.0, 355.0, 155.0]','[125.0, 165.0, 155.0, 195.0]','[85.0, 165.0, 115.0, 195.0]','[245.0, 165.0, 275.0, 195.0]','[45.0, 85.0, 75.0, 115.0]','[45.0, 125.0, 75.0, 155.0]','[205.0, 205.0, 235.0, 235.0]','[285.0, 165.0, 315.0, 195.0]','[325.0, 165.0, 355.0, 195.0]','[285.0, 85.0, 315.0, 115.0]','[325.0, 85.0, 355.0, 115.0]','[365.0, 85.0, 395.0, 115.0]','[365.0, 45.0, 395.0, 75.0]','[325.0, 45.0, 355.0, 75.0]','[165.0, 245.0, 195.0, 275.0]','[285.0, 205.0, 315.0, 235.0]','[285.0, 245.0, 315.0, 275.0]','[325.0, 245.0, 355.0, 275.0]','[365.0, 245.0, 395.0, 275.0]','[365.0, 205.0, 395.0, 235.0]','[365.0, 165.0, 395.0, 195.0]','[365.0, 125.0, 395.0, 155.0]','[85.0, 205.0, 115.0, 235.0]','[245.0, 205.0, 275.0, 235.0]','[325.0, 205.0, 355.0, 235.0]','[165.0, 285.0, 195.0, 315.0]','[205.0, 245.0, 235.0, 275.0]','[245.0, 245.0, 275.0, 275.0]','[285.0, 45.0, 315.0, 75.0]','[125.0, 285.0, 155.0, 315.0]','[205.0, 285.0, 235.0, 315.0]','[245.0, 285.0, 275.0, 315.0]','[365.0, 5.0, 395.0, 35.0]','[325.0, 5.0, 355.0, 35.0]','[285.0, 5.0, 315.0, 35.0]','[365.0, 285.0, 395.0, 315.0]','[365.0, 325.0, 395.0, 355.0]','[285.0, 285.0, 315.0, 315.0]']
        
        self.source_task_2 = {
        0:[-0.4803795448025337,0,-0.3805349722012081,-0.29260515000063103,0,-0.18290127618111898,0,-0.06731327443494595,-0.03912571449669171,0,-0.2825682077789487,-0.23973835827772602,0,0.04295683674836982,0,-0.03474659297545073,0,-0.0827511867315708,0.45051062120069546,-1.9836941046095404,-0.16708057844900023,-0.11309696917250564,0	,-3.310282414303195,-1.3125418723102171,0,-0.16637489160907112,0,0,-0.04644632596056649,-0.025549209127574427,1.1817394670736479,-0.061295923602612164,-0.29701,0,0,-0.028049411133589285,0,0,-0.1,-0.013622740762241101,0,-0.03372119208757425,0,0,-0.29701,0.018563561929497634,1.4617520778668518,0,0,-0.199,0,-0.0006185677249304876,2.0405671734669952,2.3510687454524906,-0.199,0.021694503630558765,-0.0010090000000000001,0,0,-0.017368596771420195,-0.012661504978049755,-0.01232595056015025,0,-0.008155473528169714,-0.001,-0.003014956035991,-0.0010090000000000001,-0.005061025748181493,-0.008964083874125915,-0.00498976812811,0,-0.002997001],
        1:[-5.952680273216759,0,-5.828791200667793,-5.0016297010080075,0,-5.051613403997927,0,2.648054428059136,3.315494707314692,0,-0.1365056655373889,1.475019220252604,0,-0.024243051876808978,0,4.705012873023197,0,-0.15486614336308493,-3.310282414303195,-0.1814260522552581,-1.399416453587115,-0.1115934529251741,0,6.188216729600867,-0.17096740927405127,0,-0.956179249911955,0,0,-0.046714291180175956,-0.020491986590729754,7.009197575094773,-0.046008425380346066,-0.044935034414365964,0,0,-0.490099501,0,0,-0.036822940059183185,-0.01279698733625272,0,-0.29701,0,0,-0.005710820918019685,-0.001,7.907405440160005,0,0,-0.1,0,-0.00392623219,8.899545264881988,9.99995409679676,-0.0019245498339538949,0,-0.1,0,0,-0.0172827487179627,-0.013278475773144432,-0.011665539604609079,0,-0.00784903605647509,0,-0.0029791,-0.1,-0.004954270501,-0.009155550046885166,-0.1,0,-0.1],
        2:[0.5103675461083471,0,0.9408752440071638,1.444323412879316,0,2.0189018916679324,0,-0.3232667484545447,-0.12598650035466658,0,-2.8944677272770765,-2.3765728565289628,0,4.003890850509516,0,-4.010439935338387,0,1.5012267143714413,5.427654426707244,0.19429002319908079,-0.1590487357441977,-0.956179249911955,0,0.05112560140967328,-0.1718779085735915,0,-0.16706619433611863,0,0,-0.490099501,-0.3940399,0.010329388157136219,-0.7725530557207989,-0.04417058017178923,0,0,0.24680689202081849,0,0,-0.03591406883740026,-0.29701,0,-0.031953962623013546,0,0,3.1200907314205653,1.9310889242636073,0.05483254066446022,0,0,-0.02620866627706475,0,-0.00491890501,0.16847570880567964,0.29554518222497456,-0.00199,-0.001997239287599945,-0.001,0,0,-0.01685170741242663,-0.012922285286285284,-0.011934219505791075,0,-0.007972055930055972,0,-0.002997001,-0.001999,-0.004990009995001,-0.008964083874125915,-0.005104597039789658,0,-0.0030422808079413974],
        3:[-0.4925793150425869,0,-0.43157060423045046,-0.34383366465611814,0,-0.24743692213154878,0,-0.05315343625193948,-3.1744540498961276,0,-0.28475390720244176,-0.241749733942458,0,-0.19540298304886677,0,0.23830199322661505,0,-0.1553946290855035,0.015322702987794522,-0.18154991766029252,-0.16655013257057658,-0.956179249911955,0,0.7361147677857722,-1.1361512828387073,0,-0.58519850599,0,0,1.223012509658679,0.7509563847330225,-2.9655230500043057,-0.05998404207551385,-0.6793465209301,0,0,-0.02782846204204506,0,0,-0.1,1.1636965324766333,0,-0.3940399,0,0,-0.004683088309745307,-0.199,-2.7501966404214637,0,0,-0.026403292759779616,0,1.8253729452458292,0.517333051782006,0.18517577728960613,-0.0019374565190485773,2.378760676342117,0.02333076660086769,0,0,-0.017818800787260124,-0.1,-0.199,0,-0.1,0,-0.001999,-0.00199,-0.1,-0.00878882704312311,-0.0059055900589,0,-0.199]
        }
        self.source_task2 = pd.DataFrame(self.source_task_2)
        self.source_task2.index = ['[5.0, 5.0, 35.0, 35.0]','[5.0, 45.0, 35.0, 75.0]','[45.0, 5.0, 75.0, 35.0]','[85.0, 5.0, 115.0, 35.0]','[45.0, 45.0, 75.0, 75.0]','[125.0, 5.0, 155.0, 35.0]','[85.0, 45.0, 115.0, 75.0]','[165.0, 5.0, 195.0, 35.0]','[165.0, 45.0, 195.0, 75.0]','[125.0, 45.0, 155.0, 75.0]','[205.0, 5.0, 235.0, 35.0]','[205.0, 45.0, 235.0, 75.0]','[245.0, 5.0, 275.0, 35.0]','[165.0, 85.0, 195.0, 115.0]','[245.0, 45.0, 275.0, 75.0]','[205.0, 85.0, 235.0, 115.0]','[245.0, 85.0, 275.0, 115.0]','[165.0, 125.0, 195.0, 155.0]','[205.0, 125.0, 235.0, 155.0]','[125.0, 85.0, 155.0, 115.0]','[125.0, 125.0, 155.0, 155.0]','[165.0, 165.0, 195.0, 195.0]','[125.0, 165.0, 155.0, 195.0]','[245.0, 125.0, 275.0, 155.0]','[85.0, 85.0, 115.0, 115.0]','[205.0, 165.0, 235.0, 195.0]','[85.0, 125.0, 115.0, 155.0]','[45.0, 125.0, 75.0, 155.0]','[85.0, 165.0, 115.0, 195.0]','[285.0, 125.0, 315.0, 155.0]','[285.0, 165.0, 315.0, 195.0]','[245.0, 165.0, 275.0, 195.0]','[165.0, 205.0, 195.0, 235.0]','[125.0, 205.0, 155.0, 235.0]','[45.0, 85.0, 75.0, 115.0]','[205.0, 205.0, 235.0, 235.0]','[165.0, 245.0, 195.0, 275.0]','[325.0, 165.0, 355.0, 195.0]','[165.0, 285.0, 195.0, 315.0]','[285.0, 85.0, 315.0, 115.0]','[285.0, 205.0, 315.0, 235.0]','[325.0, 205.0, 355.0, 235.0]','[125.0, 245.0, 155.0, 275.0]','[125.0, 285.0, 155.0, 315.0]','[325.0, 125.0, 355.0, 155.0]','[205.0, 245.0, 235.0, 275.0]','[205.0, 285.0, 235.0, 315.0]','[245.0, 205.0, 275.0, 235.0]','[285.0, 45.0, 315.0, 75.0]','[85.0, 205.0, 115.0, 235.0]','[325.0, 85.0, 355.0, 115.0]','[325.0, 45.0, 355.0, 75.0]','[285.0, 245.0, 315.0, 275.0]','[245.0, 245.0, 275.0, 275.0]','[245.0, 285.0, 275.0, 315.0]','[325.0, 245.0, 355.0, 275.0]','[285.0, 285.0, 315.0, 315.0]','[325.0, 285.0, 355.0, 315.0]','[325.0, 325.0, 355.0, 355.0]','[85.0, 245.0, 115.0, 275.0]','[365.0, 85.0, 395.0, 115.0]','[365.0, 45.0, 395.0, 75.0]','[365.0, 125.0, 395.0, 155.0]','[245.0, 325.0, 275.0, 355.0]','[365.0, 165.0, 395.0, 195.0]','[205.0, 325.0, 235.0, 355.0]','[365.0, 245.0, 395.0, 275.0]','[365.0, 285.0, 395.0, 315.0]','[365.0, 205.0, 395.0, 235.0]','[365.0, 5.0, 395.0, 35.0]','[325.0, 5.0, 355.0, 35.0]','[365.0, 325.0, 395.0, 355.0]','[285.0, 5.0, 315.0, 35.0]']

        self.source_task_3 = {
        0:[-0.632843717,-0.595077964,0,-0.554224176,-0.511000352,-0.460042785,-0.410890799,-0.382360339,0,0,0,-0.421375813,0,0,-0.345116257,-2.75019664,-1.820930624,-0.333137947,-0.270395898,-0.289742092,-0.314337259,0,-3.105509141,-0.251131664,0,-0.192245064,0,0,-0.315436228,-0.029555301,0,0,-0.171420031,0,-0.146389044,-0.112946315,-0.080723223,-0.054161917,0,-0.146003229,-0.156096681,-0.772553056,0,-0.864827525,-1.399416454,0,0.095197895,0.442954806,0,0,-0.490099501,0,0,0,-0.036064327,-0.019348866,0,0,-0.29701,0.680927286,0.908263499,-0.105237697,-0.094938378,-0.086976183,-0.06981833,-0.064349628,-0.060955318,0,-0.1,-0.093197741,-0.082952625,-0.075335356,0,1.162894398,-0.007133685,-0.008040637,-0.005942337,0,-0.076906919,-0.070403277,-2.452807128,0,-0.29701,-0.1,0,-0.001,-0.001,0,0,0,0,0],
        1:[-6.851908268,-6.265357195,0,-5.341192248,-5.433902523,-0.304519103,-0.051918453,-0.325748979,0,0,0,-0.419217374,0,0,0.337175447,-0.328554637,-0.320309714,0.088845354,-3.310282414,-0.301945686,-2.452807128,0,2.616389243,-0.250530511,0,-0.164361325,0,0,-1.902721318,3.672954614,0,0,-0.165097094,0,-0.143587785,-0.109711984,-0.074272249,-0.95617925,0,-1.738313762,-1.312541872,-0.174816717,0,-0.148025106,-0.0810914,0,4.759665389,5.832013133,0,0,-0.772553056,0,0,0,-0.046995214,-0.00925209,0,0,-0.069196163,6.842612735,7.847535592,-0.10589321,-0.095090946,-0.087111265,-0.069773331,-0.3940399,-0.864827525,0,-0.010841167,-0.093426417,-0.083445941,-0.075294061,0,1.09217633,-0.007972056,-0.007972056,-0.00499001,0,-0.490099501,-0.490099501,1.757394397,0,-0.005007457,-0.1,-0.1,-0.1,-0.001,0,-0.001,0,0,0],
        2:[-0.632787791,-0.591249297,0,-0.534286826,-0.447949745,-0.459804821,-0.404917864,-3.638145139,0,0,0,-3.443407794,0,0,-0.338063247,-0.304734406,-0.320679014,-2.96552305,1.735309554,0.922500823,-0.284586785,0,-0.213863687,-1.738313762,0,-1.820930624,0,0,-0.315588492,-0.15723018,0,0,-1.312541872,0,-1.136151283,-0.679346521,-0.078148841,-0.055829444,0,0.116107917,-0.153500842,-0.174505202,0,-0.14756232,1.445259877,0,-0.108014537,-0.034551786,0,0,-0.125914338,0,0,0,0.765194247,1.083979512,0,0,-0.069244393,0.029963466,-1.738313762,-0.10599199,-0.094289316,-0.087018174,-0.070408574,-0.063871931,-0.060776466,0,-0.010370304,-0.093364408,-0.082425777,-0.07504828,0,8.884794686,1.273551089,-0.007863701,-0.005060155,0,-0.077641407,-0.071024243,9.997800656,0,-0.005138882,-0.002052888,-0.001,0,-0.001,0,0,0,0,0],
        3:[-0.633257919,-0.597446307,0,-0.557531105,-0.512712541,-0.465852687,-4.129632181,-0.379862127,0,0,0,-0.422873607,0,0,-0.353565055,-0.328532284,-2.063857164,-0.327362359,-0.243790047,-0.304412512,-0.314212921,0,-0.079818107,-2.143218592,0,-0.193103873,0,0,-1.654862385,-2.822694674,0,0,-0.171532819,0,0.116759,0.256950065,0.705135028,1.055783747,0,-0.140968609,-0.95617925,-0.490099501,0,-1.399416454,-0.087127821,0,-2.063857164,0.042324747,0,0,-0.126540305,0,0,0,-0.772553056,-0.018995463,0,0,-0.068852236,-0.00483227,0.057348554,-0.10566224,-0.679346521,-0.086184384,-0.069523676,-0.064225429,-0.057810469,0,-0.01065771,-0.772553056,-0.95617925,-0.679346521,0,0.063641236,-0.007910145,-0.007858004,-0.199,0,-0.077675369,-0.772553056,1.319860517,0,-0.005879046,-0.0029701,-0.001,0,-0.001,-0.001,0,0,0,0]
        }
        self.source_task3 = pd.DataFrame(self.source_task_3)
        self.source_task3.index = ['[5.0, 5.0, 35.0, 35.0]','[45.0, 5.0, 75.0, 35.0]','[5.0, 45.0, 35.0, 75.0]','[85.0, 5.0, 115.0, 35.0]','[125.0, 5.0, 155.0, 35.0]','[165.0, 5.0, 195.0, 35.0]','[165.0, 45.0, 195.0, 75.0]','[205.0, 45.0, 235.0, 75.0]','[125.0, 45.0, 155.0, 75.0]','[45.0, 45.0, 75.0, 75.0]','[85.0, 45.0, 115.0, 75.0]','[205.0, 5.0, 235.0, 35.0]','[245.0, 45.0, 275.0, 75.0]','[245.0, 5.0, 275.0, 35.0]','[165.0, 85.0, 195.0, 115.0]','[125.0, 85.0, 155.0, 115.0]','[85.0, 85.0, 115.0, 115.0]','[205.0, 85.0, 235.0, 115.0]','[205.0, 125.0, 235.0, 155.0]','[165.0, 125.0, 195.0, 155.0]','[125.0, 125.0, 155.0, 155.0]','[245.0, 85.0, 275.0, 115.0]','[245.0, 125.0, 275.0, 155.0]','[165.0, 165.0, 195.0, 195.0]','[125.0, 165.0, 155.0, 195.0]','[165.0, 205.0, 195.0, 235.0]','[205.0, 205.0, 235.0, 235.0]','[205.0, 165.0, 235.0, 195.0]','[85.0, 125.0, 115.0, 155.0]','[245.0, 165.0, 275.0, 195.0]','[45.0, 85.0, 75.0, 115.0]','[85.0, 165.0, 115.0, 195.0]','[285.0, 125.0, 315.0, 155.0]','[45.0, 125.0, 75.0, 155.0]','[285.0, 165.0, 315.0, 195.0]','[285.0, 205.0, 315.0, 235.0]','[285.0, 245.0, 315.0, 275.0]','[285.0, 285.0, 315.0, 315.0]','[285.0, 325.0, 315.0, 355.0]','[165.0, 245.0, 195.0, 275.0]','[125.0, 245.0, 155.0, 275.0]','[125.0, 205.0, 155.0, 235.0]','[85.0, 205.0, 115.0, 235.0]','[285.0, 85.0, 315.0, 115.0]','[205.0, 245.0, 235.0, 275.0]','[325.0, 125.0, 355.0, 155.0]','[245.0, 205.0, 275.0, 235.0]','[245.0, 245.0, 275.0, 275.0]','[165.0, 285.0, 195.0, 315.0]','[325.0, 165.0, 355.0, 195.0]','[325.0, 85.0, 355.0, 115.0]','[325.0, 45.0, 355.0, 75.0]','[325.0, 205.0, 355.0, 235.0]','[85.0, 245.0, 115.0, 275.0]','[205.0, 285.0, 235.0, 315.0]','[205.0, 325.0, 235.0, 355.0]','[285.0, 45.0, 315.0, 75.0]','[125.0, 285.0, 155.0, 315.0]','[325.0, 245.0, 355.0, 275.0]','[245.0, 285.0, 275.0, 315.0]','[245.0, 325.0, 275.0, 355.0]','[365.0, 85.0, 395.0, 115.0]','[365.0, 45.0, 395.0, 75.0]','[365.0, 5.0, 395.0, 35.0]','[365.0, 245.0, 395.0, 275.0]','[365.0, 285.0, 395.0, 315.0]','[325.0, 285.0, 355.0, 315.0]','[325.0, 325.0, 355.0, 355.0]','[165.0, 325.0, 195.0, 355.0]','[365.0, 125.0, 395.0, 155.0]','[365.0, 165.0, 395.0, 195.0]','[365.0, 205.0, 395.0, 235.0]','[365.0, 325.0, 395.0, 355.0]','[245.0, 365.0, 275.0, 395.0]','[205.0, 365.0, 235.0, 395.0]','[165.0, 365.0, 195.0, 395.0]','[125.0, 365.0, 155.0, 395.0]','[85.0, 365.0, 115.0, 395.0]','[325.0, 5.0, 355.0, 35.0]','[285.0, 5.0, 315.0, 35.0]','[285.0, 365.0, 315.0, 395.0]','[325.0, 365.0, 355.0, 395.0]','[125.0, 325.0, 155.0, 355.0]','[85.0, 325.0, 115.0, 355.0]','[45.0, 325.0, 75.0, 355.0]','[5.0, 325.0, 35.0, 355.0]','[5.0, 285.0, 35.0, 315.0]','[45.0, 285.0, 75.0, 315.0]','[5.0, 245.0, 35.0, 275.0]','[5.0, 365.0, 35.0, 395.0]','[85.0, 285.0, 115.0, 315.0]','[45.0, 365.0, 75.0, 395.0]']

    #choose action
    def choose_action(self,observation):
        self.check_state_exist(observation)
        if np.random.uniform()<self.epsilon:
            state_action = self.q_table.loc[observation,:]
            action = np.random.choice(state_action[state_action == np.max(state_action)].index)
        else:
            action = np.random.choice(self.actions)
        return action
    
    def choose_ma_action(self,observation):
        self.check_state_exist(observation)
        if np.random.uniform()<self.epsilon:
            state_action = self.q_table.loc[observation,:]
            action = np.random.choice(state_action[state_action == np.max(state_action)].index)
        else:
            source_q1 = transformq(self.state_dict,self.source_task1)
            source_q2 = transformq(self.state_dict,self.source_task2)
            source_q3 = transformq(self.state_dict,self.source_task3)
            source_q = np.vstack((source_q1,source_q2,source_q3))
            task_q = transformq(self.state_dict,self.q_table)
            Cxy = compute_cxy(source_q,task_q)
            Xembed,Yembed = low_rank_align(source_q,task_q,Cxy,2)
            similarity = []
            for i in range(Xembed.shape[0]):
                similarity.append(cos_sim(Xembed[i],Yembed))
            best_source = np.argmax(similarity)
            best_source_q = source_q[best_source]
            best_source_q = best_source_q.reshape(100,4)
            best_q = pd.DataFrame(best_source_q)
            best_q.index = [
                    '[5.0, 5.0, 35.0, 35.0]',
                    '[45.0, 5.0, 75.0, 35.0]',
                    '[85.0, 5.0, 115.0, 35.0]',
                    '[125.0, 5.0, 155.0, 35.0]',
                    '[165.0, 5.0, 195.0, 35.0]',
                    '[205.0, 5.0, 235.0, 35.0]',
                    '[245.0, 5.0, 275.0, 35.0]',
                    '[285.0, 5.0, 315.0, 35.0]',
                    '[325.0, 5.0, 355.0, 35.0]',
                    '[365.0, 5.0, 395.0, 35.0]',
                    '[5.0, 45.0, 35.0, 75.0]',
                    '[45.0, 45.0, 75.0, 75.0]',
                    '[85.0, 45.0, 115.0, 75.0]',
                    '[125.0, 45.0, 155.0, 75.0]',
                    '[165.0, 45.0, 195.0, 75.0]',
                    '[205.0, 45.0, 235.0, 75.0]',
                    '[245.0, 45.0, 275.0, 75.0]',
                    '[285.0, 45.0, 315.0, 75.0]',
                    '[325.0, 45.0, 355.0, 75.0]',
                    '[365.0, 45.0, 395.0, 75.0]',
                    '[5.0, 85.0, 35.0, 115.0]',
                    '[45.0, 85.0, 75.0, 115.0]',
                    '[85.0, 85.0, 115.0, 115.0]',
                    '[125.0, 85.0, 155.0, 115.0]',
                    '[165.0, 85.0, 195.0, 115.0]',
                    '[205.0, 85.0, 235.0, 115.0]',
                    '[245.0, 85.0, 275.0, 115.0]',
                    '[285.0, 85.0, 315.0, 115.0]',
                    '[325.0, 85.0, 355.0, 115.0]',
                    '[365.0, 85.0, 395.0, 115.0]',
                    '[5.0, 125.0, 35.0, 155.0]',
                    '[45.0, 125.0, 75.0, 155.0]',
                    '[85.0, 125.0, 115.0, 155.0]',
                    '[125.0, 125.0, 155.0, 155.0]',
                    '[165.0, 125.0, 195.0, 155.0]',
                    '[205.0, 125.0, 235.0, 155.0]',
                    '[245.0, 125.0, 275.0, 155.0]',
                    '[285.0, 125.0, 315.0, 155.0]',
                    '[325.0, 125.0, 355.0, 155.0]',
                    '[365.0, 125.0, 395.0, 155.0]',
                    '[5.0, 165.0, 35.0, 195.0]',
                    '[45.0, 165.0, 75.0, 195.0]',
                    '[85.0, 165.0, 115.0, 195.0]',
                    '[125.0, 165.0, 155.0, 195.0]',
                    '[165.0, 165.0, 195.0, 195.0]',
                    '[205.0, 165.0, 235.0, 195.0]',
                    '[245.0, 165.0, 275.0, 195.0]',
                    '[285.0, 165.0, 315.0, 195.0]',
                    '[325.0, 165.0, 355.0, 195.0]',
                    '[365.0, 165.0, 395.0, 195.0]',
                    '[5.0, 205.0, 35.0, 235.0]',
                    '[45.0, 205.0, 75.0, 235.0]',
                    '[85.0, 205.0, 115.0, 235.0]',
                    '[125.0, 205.0, 155.0, 235.0]',
                    '[165.0, 205.0, 195.0, 235.0]',
                    '[205.0, 205.0, 235.0, 235.0]',
                    '[245.0, 205.0, 275.0, 235.0]',
                    '[285.0, 205.0, 315.0, 235.0]',
                    '[325.0, 205.0, 355.0, 235.0]',
                    '[365.0, 205.0, 395.0, 235.0]',
                    '[5.0, 245.0, 35.0, 275.0]',
                    '[45.0, 245.0, 75.0, 275.0]',
                    '[85.0, 245.0, 115.0, 275.0]',
                    '[125.0, 245.0, 155.0, 275.0]',
                    '[165.0, 245.0, 195.0, 275.0]',
                    '[205.0, 245.0, 235.0, 275.0]',
                    '[245.0, 245.0, 275.0, 275.0]',
                    '[285.0, 245.0, 315.0, 275.0]',
                    '[325.0, 245.0, 355.0, 275.0]',
                    '[365.0, 245.0, 395.0, 275.0]',
                    '[5.0, 285.0, 35.0, 315.0]',
                    '[45.0, 285.0, 75.0, 315.0]',
                    '[85.0, 285.0, 115.0, 315.0]',
                    '[125.0, 285.0, 155.0, 315.0]',
                    '[165.0, 285.0, 195.0, 315.0]',
                    '[205.0, 285.0, 235.0, 315.0]',
                    '[245.0, 285.0, 275.0, 315.0]',
                    '[285.0, 285.0, 315.0, 315.0]',
                    '[325.0, 285.0, 355.0, 315.0]',
                    '[365.0, 285.0, 395.0, 315.0]',
                    '[5.0, 325.0, 35.0, 355.0]',
                    '[45.0, 325.0, 75.0, 355.0]',
                    '[85.0, 325.0, 115.0, 355.0]',
                    '[125.0, 325.0, 155.0, 355.0]',
                    '[165.0, 325.0, 195.0, 355.0]',
                    '[205.0, 325.0, 235.0, 355.0]',
                    '[245.0, 325.0, 275.0, 355.0]',
                    '[285.0, 325.0, 315.0, 355.0]',
                    '[325.0, 325.0, 355.0, 355.0]',
                    '[365.0, 325.0, 395.0, 355.0]',
                    '[5.0, 365.0, 35.0, 395.0]',
                    '[45.0, 365.0, 75.0, 395.0]',
                    '[85.0, 365.0, 115.0, 395.0]',
                    '[125.0, 365.0, 155.0, 395.0]',
                    '[165.0, 365.0, 195.0, 395.0]',
                    '[205.0, 365.0, 235.0, 395.0]',
                    '[245.0, 365.0, 275.0, 395.0]',
                    '[285.0, 365.0, 315.0, 395.0]',
                    '[325.0, 365.0, 355.0, 395.0]',
                    '[365.0, 365.0, 395.0, 395.0]'
                    ]
            state_action = best_q.loc[observation,:]
            action = np.random.choice(state_action[state_action == np.max(state_action)].index)
        return action
    
    def choose_entropy_action(self,observation):
        self.check_state_exist(observation)
        q_sa = self.q_table.loc[observation,:]
        qs_max = np.max(q_sa)
        psa0 = math.exp(q_sa[0]-qs_max)/(math.exp(q_sa[0]-qs_max)+math.exp(q_sa[1]-qs_max)+math.exp(q_sa[2]-qs_max)+math.exp(q_sa[3]-qs_max))
        psa1 = math.exp(q_sa[1]-qs_max)/(math.exp(q_sa[0]-qs_max)+math.exp(q_sa[1]-qs_max)+math.exp(q_sa[2]-qs_max)+math.exp(q_sa[3]-qs_max))
        psa2 = math.exp(q_sa[2]-qs_max)/(math.exp(q_sa[0]-qs_max)+math.exp(q_sa[1]-qs_max)+math.exp(q_sa[2]-qs_max)+math.exp(q_sa[3]-qs_max))
        psa3 = math.exp(q_sa[3]-qs_max)/(math.exp(q_sa[0]-qs_max)+math.exp(q_sa[1]-qs_max)+math.exp(q_sa[2]-qs_max)+math.exp(q_sa[3]-qs_max))
        Hs = -(psa0*math.log(psa0,4)+psa1*math.log(psa1,4)+psa2*math.log(psa2,4)+psa3*math.log(psa3,4))
        if np.random.uniform()<Hs:
            state_action = self.q_table.loc[observation,:]
            action = np.random.choice(state_action[state_action == np.max(state_action)].index)
        else:
            source_q1 = transformq(self.state_dict,self.source_task1)
            source_q2 = transformq(self.state_dict,self.source_task2)
            source_q3 = transformq(self.state_dict,self.source_task3)
            source_q = np.vstack((source_q1,source_q2,source_q3))
            task_q = transformq(self.state_dict,self.q_table)
            Cxy = compute_cxy(source_q,task_q)
            Xembed,Yembed = low_rank_align(source_q,task_q,Cxy,2)
            similarity = []
            for i in range(Xembed.shape[0]):
                similarity.append(cos_sim(Xembed[i],Yembed))
            best_source = np.argmax(similarity)
            best_source_q = source_q[best_source]
            best_source_q = best_source_q.reshape(100,4)
            best_q = pd.DataFrame(best_source_q)
            best_q.index = [
                    '[5.0, 5.0, 35.0, 35.0]',
                    '[45.0, 5.0, 75.0, 35.0]',
                    '[85.0, 5.0, 115.0, 35.0]',
                    '[125.0, 5.0, 155.0, 35.0]',
                    '[165.0, 5.0, 195.0, 35.0]',
                    '[205.0, 5.0, 235.0, 35.0]',
                    '[245.0, 5.0, 275.0, 35.0]',
                    '[285.0, 5.0, 315.0, 35.0]',
                    '[325.0, 5.0, 355.0, 35.0]',
                    '[365.0, 5.0, 395.0, 35.0]',
                    '[5.0, 45.0, 35.0, 75.0]',
                    '[45.0, 45.0, 75.0, 75.0]',
                    '[85.0, 45.0, 115.0, 75.0]',
                    '[125.0, 45.0, 155.0, 75.0]',
                    '[165.0, 45.0, 195.0, 75.0]',
                    '[205.0, 45.0, 235.0, 75.0]',
                    '[245.0, 45.0, 275.0, 75.0]',
                    '[285.0, 45.0, 315.0, 75.0]',
                    '[325.0, 45.0, 355.0, 75.0]',
                    '[365.0, 45.0, 395.0, 75.0]',
                    '[5.0, 85.0, 35.0, 115.0]',
                    '[45.0, 85.0, 75.0, 115.0]',
                    '[85.0, 85.0, 115.0, 115.0]',
                    '[125.0, 85.0, 155.0, 115.0]',
                    '[165.0, 85.0, 195.0, 115.0]',
                    '[205.0, 85.0, 235.0, 115.0]',
                    '[245.0, 85.0, 275.0, 115.0]',
                    '[285.0, 85.0, 315.0, 115.0]',
                    '[325.0, 85.0, 355.0, 115.0]',
                    '[365.0, 85.0, 395.0, 115.0]',
                    '[5.0, 125.0, 35.0, 155.0]',
                    '[45.0, 125.0, 75.0, 155.0]',
                    '[85.0, 125.0, 115.0, 155.0]',
                    '[125.0, 125.0, 155.0, 155.0]',
                    '[165.0, 125.0, 195.0, 155.0]',
                    '[205.0, 125.0, 235.0, 155.0]',
                    '[245.0, 125.0, 275.0, 155.0]',
                    '[285.0, 125.0, 315.0, 155.0]',
                    '[325.0, 125.0, 355.0, 155.0]',
                    '[365.0, 125.0, 395.0, 155.0]',
                    '[5.0, 165.0, 35.0, 195.0]',
                    '[45.0, 165.0, 75.0, 195.0]',
                    '[85.0, 165.0, 115.0, 195.0]',
                    '[125.0, 165.0, 155.0, 195.0]',
                    '[165.0, 165.0, 195.0, 195.0]',
                    '[205.0, 165.0, 235.0, 195.0]',
                    '[245.0, 165.0, 275.0, 195.0]',
                    '[285.0, 165.0, 315.0, 195.0]',
                    '[325.0, 165.0, 355.0, 195.0]',
                    '[365.0, 165.0, 395.0, 195.0]',
                    '[5.0, 205.0, 35.0, 235.0]',
                    '[45.0, 205.0, 75.0, 235.0]',
                    '[85.0, 205.0, 115.0, 235.0]',
                    '[125.0, 205.0, 155.0, 235.0]',
                    '[165.0, 205.0, 195.0, 235.0]',
                    '[205.0, 205.0, 235.0, 235.0]',
                    '[245.0, 205.0, 275.0, 235.0]',
                    '[285.0, 205.0, 315.0, 235.0]',
                    '[325.0, 205.0, 355.0, 235.0]',
                    '[365.0, 205.0, 395.0, 235.0]',
                    '[5.0, 245.0, 35.0, 275.0]',
                    '[45.0, 245.0, 75.0, 275.0]',
                    '[85.0, 245.0, 115.0, 275.0]',
                    '[125.0, 245.0, 155.0, 275.0]',
                    '[165.0, 245.0, 195.0, 275.0]',
                    '[205.0, 245.0, 235.0, 275.0]',
                    '[245.0, 245.0, 275.0, 275.0]',
                    '[285.0, 245.0, 315.0, 275.0]',
                    '[325.0, 245.0, 355.0, 275.0]',
                    '[365.0, 245.0, 395.0, 275.0]',
                    '[5.0, 285.0, 35.0, 315.0]',
                    '[45.0, 285.0, 75.0, 315.0]',
                    '[85.0, 285.0, 115.0, 315.0]',
                    '[125.0, 285.0, 155.0, 315.0]',
                    '[165.0, 285.0, 195.0, 315.0]',
                    '[205.0, 285.0, 235.0, 315.0]',
                    '[245.0, 285.0, 275.0, 315.0]',
                    '[285.0, 285.0, 315.0, 315.0]',
                    '[325.0, 285.0, 355.0, 315.0]',
                    '[365.0, 285.0, 395.0, 315.0]',
                    '[5.0, 325.0, 35.0, 355.0]',
                    '[45.0, 325.0, 75.0, 355.0]',
                    '[85.0, 325.0, 115.0, 355.0]',
                    '[125.0, 325.0, 155.0, 355.0]',
                    '[165.0, 325.0, 195.0, 355.0]',
                    '[205.0, 325.0, 235.0, 355.0]',
                    '[245.0, 325.0, 275.0, 355.0]',
                    '[285.0, 325.0, 315.0, 355.0]',
                    '[325.0, 325.0, 355.0, 355.0]',
                    '[365.0, 325.0, 395.0, 355.0]',
                    '[5.0, 365.0, 35.0, 395.0]',
                    '[45.0, 365.0, 75.0, 395.0]',
                    '[85.0, 365.0, 115.0, 395.0]',
                    '[125.0, 365.0, 155.0, 395.0]',
                    '[165.0, 365.0, 195.0, 395.0]',
                    '[205.0, 365.0, 235.0, 395.0]',
                    '[245.0, 365.0, 275.0, 395.0]',
                    '[285.0, 365.0, 315.0, 395.0]',
                    '[325.0, 365.0, 355.0, 395.0]',
                    '[365.0, 365.0, 395.0, 395.0]'
                    ]
            state_action = best_q.loc[observation,:]
            action = np.random.choice(state_action[state_action == np.max(state_action)].index)
        return action
    
    #learn
    def learn(self,s,a,r,s_):
        self.check_state_exist(s_)
        q_predict = self.q_table.loc[s,a]
        #if s_!='terminal':
        if r == -0.1:
            q_target = r+self.gamma*self.q_table.loc[s_,:].max()
        else:
            q_target = r
        self.q_table.loc[s,a]+=self.lr*(q_target-q_predict)
    
    #check one state exist or not
    def check_state_exist(self,state):
        if state not in self.q_table.index:
            self.q_table = self.q_table.append(
                    pd.Series(
                            [0]*len(self.actions),
                            index = self.q_table.columns,
                            name = state,
                            )
                    )
                    
                    